name: Dependabot & Deprecated NPM Alerts to Webex

on:
  # ÊØè 8 Â∞èÊó∂ÂÆöÊó∂Ëß¶Âèë
  schedule:
    - cron: "0 */8 * * *"

  # ÊâãÂä®Ëß¶Âèë
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # 3. ÂÆâË£Ö‰æùËµñ
      - name: Install dependencies
        run: npm install --package-lock-only

      # 4. Ê£ÄÊµã Deprecated ÂåÖ
      - name: Check deprecated NPM packages
        id: deprecated
        run: |
          node -e "
            const { execSync } = require('child_process');
            const fs = require('fs');
            const pkg = require('./package.json');
            const deprecated = [];
            Object.keys(pkg.dependencies || {}).forEach(name => {
              try {
                const info = execSync(\`npm view \${name} deprecated\`).toString().trim();
                if(info) deprecated.push({name, info});
              } catch(e) {}
            });
            fs.writeFileSync('deprecated.json', JSON.stringify(deprecated, null, 2));
            console.log('Found ' + deprecated.length + ' deprecated packages');
          "

      # 5. ÊãâÂèñ Dependabot Alerts
      - name: Fetch Dependabot Alerts
        id: dependabot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ALERTS=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/xinhyao/protobuf-demo/dependabot/alerts?state=open")

          echo "$ALERTS" > dependabot.json
          COUNT=$(echo "$ALERTS" | jq '. | length')
          echo "DEPENDABOT_COUNT=$COUNT" >> $GITHUB_ENV
          echo "Dependabot alerts count: $COUNT"

      # 6. ÊûÑÂª∫Ê∂àÊÅØÂπ∂ÂèëÈÄÅ Webex
      - name: Send Alerts to Webex
        run: |
          MESSAGE=""

          # 6a. Dependabot Alerts
          if [ "${DEPENDABOT_COUNT}" -gt 0 ]; then
            MESSAGE="$MESSAGEüö® **Dependabot Alerts for ${{ github.repository }}**"$'\n'
            jq -r '.[] | "- **\(.security_advisory.package.name)**: Severity: \(.security_advisory.severity), Patched: \(.security_advisory.fixed_version // "N/A"), [View Alert](\(.html_url))"' dependabot.json >> db_msg.txt
            MESSAGE="$MESSAGE"$'\n'"$(cat db_msg.txt)"
          else
            MESSAGE="$MESSAGE‚úÖ No open Dependabot alerts."
          fi

          # 6b. Deprecated ÂåÖ
          DEPRECATED_COUNT=$(jq '. | length' deprecated.json)
          if [ "$DEPRECATED_COUNT" -gt 0 ]; then
            DEPRECATED_MSG=$(jq -r '.[] | "- **\(.name)**: \(.info)"' deprecated.json)
            MESSAGE="$MESSAGE"$'\n\n‚ö†Ô∏è **Deprecated / Unmaintained NPM packages**"$'\n'"$DEPRECATED_MSG"
          fi

          # JSON ËΩ¨‰πâ
          ESCAPED_MESSAGE=$(echo "$MESSAGE" | python3 -c 'import json,sys; print(json.dumps(sys.stdin.read()))')

          # ÂèëÈÄÅ Webex
          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.WEBEX_BOT_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d "{\"roomId\": \"${{ secrets.WEBEX_ROOM_ID }}\", \"markdown\": $ESCAPED_MESSAGE}" \
            https://webexapis.com/v1/messages

          echo "Message sent to Webex successfully."
